name: Test

on:
  pull_request:
  push:
    branches: [test-action-workflow]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  test-basic:
    runs-on: ubuntu-latest
    steps:
      # First checkout the action code from the PR/push branch
      - uses: actions/checkout@v4
        with:
          path: action
          fetch-depth: 2

      - name: Create test branch
        uses: Songmu/action-create-branch@v0
        with:
          branch: test-branch-basic

      # Then checkout the test branch to a different directory
      - uses: actions/checkout@v4
        with:
          ref: test-branch-basic
          path: test-repo
          fetch-depth: 2

      - name: Create test file
        working-directory: test-repo
        run: |
          echo "Test content $(date)" > test-file.txt

      - name: Test first commit (should create new)
        uses: ./action
        with:
          commit_message: 'test: automated test commit'
          id: 'test-basic'
          files: test-file.txt

  test-rewrite:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: action
          fetch-depth: 2

      - name: Create test branch
        uses: Songmu/action-create-branch@v0
        with:
          branch: test-branch-rewrite

      - uses: actions/checkout@v4
        with:
          ref: test-branch-rewrite
          path: test-repo
          fetch-depth: 2

      - name: Create first test file
        working-directory: test-repo
        run: |
          echo "Initial content" > rewrite-test.txt

      - name: First commit with ID
        uses: ./action
        with:
          commit_message: 'test: rewrite test - initial'
          id: 'rewrite-test'
          files: rewrite-test.txt

      - name: Modify the file
        working-directory: test-repo
        run: |
          echo "Updated content $(date)" > rewrite-test.txt

      - name: Second commit with same ID (should rewrite)
        uses: ./action
        with:
          commit_message: 'test: rewrite test - updated'
          id: 'rewrite-test'
          files: rewrite-test.txt

  test-multiple-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: action
          fetch-depth: 2

      - name: Create test branch
        uses: Songmu/action-create-branch@v0
        with:
          branch: test-branch-multi

      - uses: actions/checkout@v4
        with:
          ref: test-branch-multi
          path: test-repo
          fetch-depth: 2

      - name: Create multiple files
        working-directory: test-repo
        run: |
          mkdir -p test-dir
          echo "File 1" > test-dir/file1.txt
          echo "File 2" > test-dir/file2.txt
          echo "File 3" > test-dir/file3.txt

      - name: Commit multiple files
        uses: ./action
        with:
          commit_message: |
            test: multiple files commit

            Testing with multiple files in a directory
          id: 'multi-file-test'
          files: |
            test-dir/file1.txt
            test-dir/file2.txt
            test-dir/file3.txt

  test-all-changes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: action
          fetch-depth: 2

      - name: Create test branch
        uses: Songmu/action-create-branch@v0
        with:
          branch: test-branch-all

      - uses: actions/checkout@v4
        with:
          ref: test-branch-all
          path: test-repo
          fetch-depth: 2

      - name: Create various changes
        working-directory: test-repo
        run: |
          echo "New file" > new-file.txt
          mkdir -p nested/deep
          echo "Nested file" > nested/deep/file.txt
          echo "Another file" > another.txt

      - name: Commit all changes (no files specified)
        uses: ./action
        with:
          commit_message: 'test: commit all changes'
          id: 'all-changes-test'

  test-auto-branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: action
          fetch-depth: 2

      - name: Create test branch
        uses: Songmu/action-create-branch@v0
        with:
          branch: test-branch-auto

      - uses: actions/checkout@v4
        with:
          ref: test-branch-auto
          path: test-repo
          fetch-depth: 2

      - name: Create test content
        working-directory: test-repo
        run: |
          echo "Branch detection test" > branch-test.txt

      - name: Commit without specifying branch
        uses: ./action
        with:
          commit_message: 'test: auto branch detection'
          id: 'branch-test'
          files: branch-test.txt

      - name: Verify commit was created
        working-directory: test-repo
        run: |
          git log -1 --oneline
          git log -1 --format="%B" | grep -q "X-Commit-Rewrite-ID: branch-test" || (echo "Trailer not found!" && exit 1)

  test-sequential:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: action
          fetch-depth: 2

      - name: Create test branch
        uses: Songmu/action-create-branch@v0
        with:
          branch: test-branch-sequential

      - uses: actions/checkout@v4
        with:
          ref: test-branch-sequential
          path: test-repo
          fetch-depth: 2

      - name: Initial commit
        working-directory: test-repo
        run: |
          echo "Version 1" > sequential.txt

      - name: Commit v1
        uses: ./action
        with:
          commit_message: 'test: sequential v1'
          id: 'sequential-test'
          files: sequential.txt

      - name: Update to v2
        working-directory: test-repo
        run: |
          echo "Version 2" > sequential.txt

      - name: Rewrite to v2
        uses: ./action
        with:
          commit_message: 'test: sequential v2'
          id: 'sequential-test'
          files: sequential.txt

      - name: Update to v3
        working-directory: test-repo
        run: |
          echo "Version 3" > sequential.txt

      - name: Rewrite to v3
        uses: ./action
        with:
          commit_message: 'test: sequential v3'
          id: 'sequential-test'
          files: sequential.txt

      - name: Verify only one commit exists
        working-directory: test-repo
        run: |
          COMMIT_COUNT=$(git log --oneline --grep="sequential" | wc -l)
          echo "Found $COMMIT_COUNT commits with 'sequential'"
          if [ "$COMMIT_COUNT" -ne 1 ]; then
            echo "Expected 1 commit, found $COMMIT_COUNT"
            exit 1
          fi
