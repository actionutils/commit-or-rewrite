name: 'Commit or Rewrite (Signed)'
description: 'Creates signed/verified commits or rewrites existing ones using GitHub API. Supports GitHub App tokens for verified commits without GPG keys.'
inputs:
  commit_message:
    description: 'Commit message (can be multiline)'
    required: true
  trailer_id:
    description: 'Unique identifier for the trailer (e.g., changelog-update)'
    required: true
  branch:
    description: 'Target branch'
    required: true
  files:
    description: 'Files to commit (newline-separated). If empty, commits all changes'
    required: false
    default: ''
  github_token:
    description: 'GitHub token for API operations'
    required: false
    default: ${{ github.token }}

runs:
  using: 'composite'
  steps:
    - name: Check for changes
      id: check-changes
      shell: bash
      env:
        FILES: ${{ inputs.files }}
      run: |
        # Get files list - use provided files or get all changed files
        if [ -z "$FILES" ]; then
          echo "No files specified, getting all changed files"
          FILES=$(git diff --name-only HEAD; git diff --cached --name-only HEAD; git ls-files --others --exclude-standard)
        fi

        # Process files list (dedupe, convert to space-separated, trim)
        FILES_LIST=$(echo "$FILES" | sort -u | tr '\n' ' ' | sed 's/[[:space:]]*$//')

        # Store files list for later use
        echo "files_list=$FILES_LIST" >> $GITHUB_OUTPUT

        # Check if there are any changes
        if [ -z "$FILES_LIST" ]; then
          echo "No files to commit"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "Changes detected"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Check if HEAD has matching trailer
      if: steps.check-changes.outputs.has_changes == 'true'
      id: check-trailer
      shell: bash
      env:
        TRAILER_ID: ${{ inputs.trailer_id }}
      run: |
        # Check if HEAD commit has our trailer using git interpret-trailers
        COMMIT_MSG=$(git log -1 --format=%B)
        TRAILER_VALUE=$(echo "$COMMIT_MSG" | git interpret-trailers --parse | grep "^X-Commit-Rewrite-ID:" | cut -d' ' -f2- || true)

        if [ "$TRAILER_VALUE" = "$TRAILER_ID" ]; then
          echo "HEAD has matching trailer (X-Commit-Rewrite-ID: $TRAILER_ID)"
          echo "should_reset=true" >> $GITHUB_OUTPUT
          # Store parent SHA for later use
          PARENT_SHA=$(git rev-parse HEAD~1)
          echo "parent_sha=$PARENT_SHA" >> $GITHUB_OUTPUT
        else
          echo "HEAD does not have matching trailer"
          echo "should_reset=false" >> $GITHUB_OUTPUT
        fi

    - name: Reset to parent if needed
      if: steps.check-changes.outputs.has_changes == 'true' && steps.check-trailer.outputs.should_reset == 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        BRANCH: ${{ inputs.branch }}
        PARENT_SHA: ${{ steps.check-trailer.outputs.parent_sha }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "Resetting branch to parent commit: $PARENT_SHA"

        # Use GitHub API to update the branch reference to parent
        curl -X PATCH \
          -H "Authorization: token $GITHUB_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/git/refs/heads/$BRANCH" \
          -d "{\"sha\":\"$PARENT_SHA\",\"force\":true}"

    - name: Create commit with trailer
      if: steps.check-changes.outputs.has_changes == 'true'
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        BRANCH: ${{ inputs.branch }}
        FILES_LIST: ${{ steps.check-changes.outputs.files_list }}
        COMMIT_MESSAGE: ${{ inputs.commit_message }}
        TRAILER_ID: ${{ inputs.trailer_id }}
        ACTION_PATH: ${{ github.action_path }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        # Create commit message with trailer
        FULL_MESSAGE="${COMMIT_MESSAGE}

        X-Commit-Rewrite-ID: ${TRAILER_ID}"

        # Get the script path relative to the action directory
        SCRIPT_PATH="${ACTION_PATH}/run-ghcp.sh"

        # Commit using ghcp
        "$SCRIPT_PATH" -- commit \
          -r "$GITHUB_REPOSITORY" \
          -b "$BRANCH" \
          -m "$FULL_MESSAGE" \
          $FILES_LIST

    - name: Sync local git state with remote
      if: steps.check-changes.outputs.has_changes == 'true'
      shell: bash
      env:
        BRANCH: ${{ inputs.branch }}
      run: |
        echo "Syncing local git state with remote branch: $BRANCH"
        # Fetch the latest state of the branch
        git fetch origin "$BRANCH"

        # Reset the current branch to match remote
        # This updates HEAD and the index without touching the working tree
        git reset "origin/$BRANCH"

        # Clean up the index to match HEAD (discard staged changes)
        git reset --mixed HEAD
